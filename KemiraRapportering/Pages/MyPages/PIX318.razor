@page "/PIX-318"

@using DataAccesLib
@using DataAccesLib.Models
@using BlazorDateRangePicker;

@inject IRecipeData _db


<h1>Resept: PIX-318</h1>


<h5 class ="mx-5">&nbsp;&nbsp;&nbsp; Dato &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Antall Rader</h5>

@if (recipes is null)
{
    <p><em>Loading....</em></p>
}
else
{


    

   

    <div class="btn-group">
        <DateRangePicker placeholder="Velg Dato" @bind-StartDate="StartDate" @bind-EndDate="EndDate" OnRangeSelect="OnRangeSelect">

        </DateRangePicker>
    </div>

    <input type="number" @bind-value="Queries.TableLen" @bind-value:event="oninput" />
    



  <div>
      <table class="table table-striped">
        <thead>
            <tr>
    
                @for(int i = 0; i < 29; i++)
                {

                        @if (!FilterModel.filter[i])
                        {
                            <th>@FilterModel.StringFilter[i]</th>
                        }

                }
                

            </tr>
        </thead>
        <tbody>
                

                @foreach (var recipe in RecipeRead.Table)
            {


                    @if (!recipe.edit)
                    {
                        <tr @key="recipe">

                           @if (!FilterModel.filter[0])
                            {
                                <td>@recipe.BatchNr</td>
                            }
                            @if (!FilterModel.filter[1])
                            {
                                <td>@recipe.Dato</td>
                            }
                            @if (!FilterModel.filter[2])
                            {
                                <td>@recipe.SAP</td>
                            }

                            @if (!FilterModel.filter[3])
                            {
                                <td>@recipe.ID</td>
                            }

                            @if (!FilterModel.filter[4])
                            {
                                <td>@recipe.Reaktor</td>
                            }

                            @if (!FilterModel.filter[5])
                            {
                                <td>@recipe.SatsVolum</td>
                            }

                            @if (!FilterModel.filter[6])
                            {
                                <td>@recipe.ForvFe</td>
                            }

                            @if (!FilterModel.filter[7])
                            {
                                <td>@recipe.OnsketFe</td>
                            }

                            @if (!FilterModel.filter[8])
                            {
                                <td>@recipe.OnsketSyre</td>
                            }

                            @if (!FilterModel.filter[9])
                            {
                                <td>@recipe.OnsketFe2</td>
                            }

                            @if (!FilterModel.filter[10])
                            {
                                <td>@recipe.HCLType</td>
                            }

                            @if (!FilterModel.filter[11])
                            {
                                <td>@recipe.ForvDamp</td>
                            }

                            @if (!FilterModel.filter[12])
                            {
                                <td>@recipe.VannOverordnet</td>
                            }

                            @if (!FilterModel.filter[13])
                            {
                                <td>@recipe.VarmtVann</td>
                            }

                            @if (!FilterModel.filter[14])
                            {
                                <td>@recipe.SpillVann</td>
                            }

                            @if (!FilterModel.filter[15])
                            {
                                <td>@recipe.ScrubberVaeske</td>
                            }

                            @if (!FilterModel.filter[16])
                            {
                                <th>@recipe.HCL</th>
                            }

                            @if (!FilterModel.filter[17])
                            {
                                <th>@recipe.Jernsulfat</th>
                            }

                            @if (!FilterModel.filter[18])
                            {
                                <th>@recipe.Temp</th>
                            }

                            @if (!FilterModel.filter[19])
                            {
                                <th>@recipe.Modningstid</th>
                            }

                            @if (!FilterModel.filter[20])
                            {
                                <th>@recipe.DampVentil</th>
                            }

                            @if (!FilterModel.filter[21])
                            {
                                <th>@recipe.Etterspyling</th>
                            }

                            @if (!FilterModel.filter[22])
                            {
                                <th>@recipe.O2Trykk</th>
                            }

                            @if (!FilterModel.filter[23])
                            {
                                <th>@recipe.O2Reaksjonstid</th>
                            }

                            @if (!FilterModel.filter[24])
                            {
                                <th>@recipe.DeltaTemp</th>
                            }

                            @if (!FilterModel.filter[25])
                            {
                                <th>@recipe.AnalysertFe3</th>
                            }

                            @if (!FilterModel.filter[26])
                            {
                                <th>@recipe.AnalysertFeTot</th>
                            }

                            @if (!FilterModel.filter[27])
                            {
                                <th>@recipe.VannSluttJustering</th>
                            }

                            @if (!FilterModel.filter[28])
                            {
                                <th>@recipe.VirkeligMVann</th>
                            }

                            @if (!FilterModel.filter[29])
                            {
                                <th>@recipe.TotTilLager</th>
                            }



                    <th>
                        <button type="button" class="btn btn-link">
                        <span class="oi oi-pencil" aria-hidden="true" @onclick="() => EnableEditing(true, recipe)"></span>
                        </button>
                    </th>
                        
                        </tr>
                    }
                    else
                    {
                             @if (!filter[0].sort)
                            {
                                <td>
                                <input type="number" class="form-control" placeholder="@recipe.BatchNr.ToString()" value="@RecipeEdit.BatchNr" />
</td>
                            }
                            @if (!filter[1].sort)
                            {
                                <td>
                                <input type="number" class="form-control" placeholder="@recipe.Dato" value="" />
</td>
                            }
                            @if (!filter[2].sort)
                            {
                                <td>
                                <input type="number" class="form-control" placeholder="@recipe.SAP.ToString()" value="@RecipeEdit.SAP" />
                                </td>
                            }

                            @if (!filter[3].sort)
                            {
                                <td>
                                <input type="text" class="form-control" placeholder="@recipe.ID" value="@RecipeEdit.ID" />
                                 </td>
                            }

                            @if (!filter[4].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[5].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[6].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[7].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[8].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[9].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[10].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[11].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[12].sort)
                            {
                                <td>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[13].sort)
                            {
                                <td>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[14].sort)
                            {
                                <td>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[15].sort)
                            {
                                <td>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</td>
                            }

                            @if (!filter[16].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[17].sort)
                            {
                                <th>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[18].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[19].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[20].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[21].sort)
                            {
                                <th>

                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[22].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[23].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[24].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[25].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[26].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[27].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[28].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }

                            @if (!filter[29].sort)
                            {
                                <th>
                                <input type="number" class="form-control" placeholder="" value="@RecipeEdit.SAP" />
</th>
                            }
                            <td>
                    <button type="button" class="btn btn-link" @onclick="() => EnableEditing(false, recipe)">
                        <i class="oi oi-trash" />
                    </button>
                    <button type="button" class="btn btn-link">
                        <i class="oi oi-check" />
                    </button>
                </td>
                    }
            }
        </tbody>
    </table>
  </div>




    <div class="btn-group  text-rt" role="group" aria-label="Reset">
        <button type="button" class="btn btn-success btn-lg mx-3" @onclick="() => WriteCSV(filter)">Eksporter til Excel</button>
        <button type="button" class="btn btn-secondary btn-lg text-right" @onclick="() => resetTable()">Reset Tabell</button>
    </div>

    <div class="my-5"></div>

    <h4>Fjerne/Legge til kolonner</h4>

    <ul class="list-group d-inline-block">

   @for(int j = 0; j < 29; j++)
    {


            @if (!filter[j].sort)
            {
                <li class="list-group-item list-group-item-primary"
                
              @onclick = "(() => {FilterChange(true, j); StateHasChanged();})">
             
              @FilterModel.StringFilter[j]
            </li>
            }
        else
            {
             <li class="list-group-item list-group-item-secondary"
              @onclick = "(() => {FilterModel.filter[j] = false; StateHasChanged();})">
             <del>@FilterModel.StringFilter[j]</del> 
            </li>   
            }
    }
            



    

</ul>

}



@code {


    private string value { get; set; }

    private string batch { get; set; }

    private int TableLen = Queries.TableLen;

    private List<RecipeModels> recipes;
    private RecipeModels RecipeEdit = new RecipeModels();



    public  List<string> RecipeVariables = new List<string>()
        {
        "Batch",
        "Dato",
        "SAP",
        "ID",
        "Reaktor",
        "Satsvolum",
        "Forventet Fe",
        "Onsket Fe",
        "Onsket Syre",
        "Onsket Fe2",
        "HCL type",
        "Forv. Damp",
        "Vann Overordnet",
        "Varmt Vann",
        "Spill Vann",
        "Scrubber Væske",
        "HCL",
        "Jernsulfat",
        "Temp",
        "Modningstid",
        "Damp Ventil",
        "Etter spyling",
        "O2 Trykk",
        "O2 Reaksjonstid",
        "DeltaTemp",
        "Analysert Fe3",
        "Analysert FeTot",
        "VannSlutt justering",
        "Virkelig Mengde Vann",
        "Tot til lager"
    };



    public filtering[] filter = new filtering[30];
    public bool FilterSet { get; set; }


    DateTimeOffset? StartDate { get; set; } = DateTime.Today.AddDays(-7);
    DateTimeOffset? EndDate { get; set; } = DateTime.Today.AddDays(0).AddTicks(-1);


    Queries query = new Queries();

    public void OnRangeSelect(DateRange range)
    {

        string sql = query.DateQuery(range);
        TableUpdate();
    }




    protected override async Task OnInitializedAsync()
    {
        string sql = query.pix318();


        recipes = await _db.GetRecipes(sql);



        RecipeRead.Table = recipes;
        TableUpdate();

        for(int i = 0; i < 30; i++)
        {
            filter[i] = new filtering();
            filter[i].variable = RecipeVariables[i];
        }

        //Make this part of initialization
        filter[5].sort = true;
        filter[19].sort = true;
        filter[20].sort = true;
        filter[21].sort = true;
        filter[22].sort = true;
        filter[24].sort = true;
        FilterModel.filter[5] = true;
        FilterModel.filter[19] = true;
        FilterModel.filter[20] = true;
        FilterModel.filter[21] = true;
        FilterModel.filter[22] = true;
        FilterModel.filter[24] = true;




    }

    public async void TableUpdate()
    {

        recipes = await _db.GetRecipes(Queries.sql);
        RecipeRead.Table = recipes;
        //await InvokeAsync(StateHasChanged);
        StateHasChanged();
    }

    public async Task resetTable()
    {
        string sql = $"SELECT top ({ Queries.TableLen }) * FROM PIX318_ReseptData ORDER BY BatchNr DESC";
        recipes = await _db.GetRecipes(sql);
        RecipeRead.Table = recipes;



    }

    public void ResetDropDown()
    {
        StateHasChanged();
    }





    public void WriteCSV(filtering[] filter)
    {
        DataWrite ToCSV = new DataWrite(filter);

        ToCSV.dataWriteToCSV();

    }

    private void EnableEditing(bool flag, RecipeModels batch)
    {
        batch.edit = flag;
    }


    private void FilterChange(bool flag, int index)
    {
        FilterModel.filter[index] = flag;
        filter[index].sort = flag;
        StateHasChanged();
    }

}
